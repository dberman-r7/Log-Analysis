# CR-2026-02-11-001: Rapid7 log selection and query polling alignment

**Requestor**: User  
**Date**: 2026-02-11  
**Category**: BUG + DOCUMENTATION  
**Priority**: P1-HIGH

## Title
Fix log selection to use a single logsets call (embedded `logs_info`) and align Log Search query execution with Rapid7 polling & pagination semantics.

## Description
The CLI utility should:

1. **Log selection (interactive)**
   - Fetch **log sets** using `GET /management/logsets`.
   - Allow the user to select a log set.
   - List logs belonging to the selected log set using **only** embedded `logs_info` from the logsets response.
   - Allow the user to select a log.
   - Persist the chosen log id to `.env` as `RAPID7_LOG_KEY`.

2. **Log query execution**
   - Execute `GET /query/logs/{LOG_KEY}` with `from`, `to`, and `query` parameters.
   - Poll to completion using provider `links` semantics (poll while `Self` exists).
   - Paginate result pages while `Next` exists.
   - Handle 429 rate limits using `Retry-After` and/or `X-RateLimit-Reset`.

3. **Documentation**
   - Ensure CLI docs match correct invocation (`python3 -m src.log_ingestion.main ...`).
   - Ensure default output directory guidance matches actual defaults (`./data/logs`).

## Business Justification
- Prevents runtime failures due to unsupported membership endpoints returning 404.
- Ensures query execution follows provider sample behavior, reducing risk of incomplete results or improper polling.
- Improves local developer experience on macOS (correct invocation + writable default output directory).

## Affected Components
- `src/log_ingestion/main.py` (interactive selection UX, fail-loudly messaging)
- `src/log_ingestion/api_client.py` (query polling, pagination, 429 handling)
- `src/log_ingestion/config.py` and `src/log_ingestion/parquet_writer.py` (output dir defaults + fail loudly)
- `docs/requirements/rtm.md` (requirements updates)
- `README.md` and/or `docs/runbooks/log-ingestion-service.md` (usage updates)
- Unit tests under `tests/`
