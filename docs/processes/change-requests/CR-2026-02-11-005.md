# CR-2026-02-11-005: Clear per-page/poll progress observability in `fetch_logs()` pagination

**Requestor**: User  
**Date**: 2026-02-11  
**Category**: DOCUMENTATION  
**Priority**: P2-MEDIUM

## Title
Clear per-page/poll progress observability in `Rapid7ApiClient.fetch_logs()` pagination.

## Description
Improve INFO-level progress observability in `Rapid7ApiClient.fetch_logs()` so it’s immediately obvious in logs that pagination is advancing (page-by-page), and correlate poll/page logs with a stable `fetch_id`. Add fail-loud detection for pagination that doesn’t advance (e.g., repeating `Next` URL).

## Business Justification
It’s currently hard to tell from runtime output whether we’re working through responses or stuck. Clear, consistent progress logs reduce MTTR during large fetches and API anomalies and align with repo governance principles ("Fail Loudly", "Born to be Monitored").

## Affected Components
- `src/log_ingestion/api_client.py` (`Rapid7ApiClient.fetch_logs()` + pagination loop)
- `tests/test_api_client_progress_observability.py`
- `docs/requirements/rtm.md`

---

## Impact Assessment (IA)

### 1) Code Impact
- **Files modified**:
  - `src/log_ingestion/api_client.py`
    - Add/standardize INFO progress events per page and overall fetch.
    - Add stuck-pagination detection and explicit error event + exception.
  - `tests/test_api_client_progress_observability.py`
    - Validate per-page progress logs with `fetch_id` correlation.
    - Validate fail-loud behavior when `Next` repeats.
  - `docs/requirements/rtm.md`
    - Update REQ-026 trace links/status after implementation.
- **Dependencies affected**: None expected.
- **API surface changes**: No public interface changes (log events and internal safeguards only).
- **Breaking changes**: NO.

### 2) Security Impact
- Ensure logs stay secret-safe:
  - Do not log API keys or auth headers.
  - Avoid logging full `Next` URLs; log a stable fingerprint instead.
- No auth/authz changes.

### 3) Performance Impact
- Minimal overhead from additional structured logs and URL fingerprint calculation.
- No change expected in network calls / rate limiting behavior.

### 4) Testing Impact
- Add/adjust unit tests that assert:
  - `logsearch_fetch_start`, `logsearch_page_complete`, `logsearch_fetch_complete` emitted.
  - `logsearch_page_complete` emitted once per page with `fetch_id` and `page_num`.
  - Stuck pagination emits `logsearch_pagination_not_advancing` and raises `RuntimeError`.

### 5) Documentation Impact
- RTM must be updated to prevent documentation drift.
- No ADR expected (no architectural change).

---

## Requirements & Traceability
- **REQ-014**: Pagination via `links[rel=Next]`
- **REQ-025**: Poll debug/log visibility
- **REQ-026**: Progress logs correlate pagination + poll activity (fetch_id/page_num)

---

## Implementation Plan (Checklist)

### Pre-Implementation
- [ ] Requirement decomposition completed (confirm REQ-014/025/026 in RTM).
- [ ] Security review performed (verify no sensitive values are logged).

### TDD (Red → Green → Refactor)
- [ ] **RED**: Ensure `tests/test_api_client_progress_observability.py` fails for missing events/fields.
- [ ] **GREEN**: Implement minimal logging + stuck pagination detection in `src/log_ingestion/api_client.py`.
- [ ] **REFACTOR**: Consolidate URL fingerprint helper; keep event names consistent across the API client.

### Observability
- [ ] Emit `logsearch_fetch_start` (INFO) with `fetch_id`.
- [ ] Emit `logsearch_page_complete` (INFO) once per page with `fetch_id`, `page_num`, `event_count`, `has_next`.
- [ ] Emit `logsearch_fetch_complete` (INFO) with totals.
- [ ] Emit `logsearch_pagination_not_advancing` (ERROR) and raise `RuntimeError`.

### Validation
- [ ] Unit tests pass.
- [ ] Coverage ≥ 80% (no decrease).
- [ ] Update `docs/requirements/rtm.md` links/status for REQ-026.

## Files To Modify
- `src/log_ingestion/api_client.py` — implement progress logs + fail-loud loop detection.
- `tests/test_api_client_progress_observability.py` — tests for progress logs and stuck pagination.
- `docs/requirements/rtm.md` — traceability updates.
