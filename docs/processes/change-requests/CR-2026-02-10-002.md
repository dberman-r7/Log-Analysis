# Change Request: CR-2026-02-10-002

**Status**: DRAFT

**Created**: 2026-02-10  
**Last Updated**: 2026-02-10

---

## Basic Information

**Title**: Align Rapid7 API client with provider Log Search polling + link pagination

**Requestor**: User

**Category**: FEATURE

**Priority**: P1 - HIGH

---

## Description

### Problem Statement

The current `Rapid7ApiClient` implementation assumes a synchronous CSV export-style API (`/logs`) using `Authorization: Bearer ...` and token/header based pagination. The API provider’s sample code indicates the **Rapid7 Log Search API** uses:

- `x-api-key` authentication header
- a Log Search endpoint shaped like:
  `https://{region}.rest.logs.insight.rapid7.com/query/logs/{log_key}`
- asynchronous query completion via a `links` array with `rel` values of `Self` (poll continuation while query is running) and `Next` (pagination)
- explicit HTTP 429 handling using `X-RateLimit-Reset` seconds

Without aligning to these semantics, the service may fail to fetch logs reliably, mishandle rate limits, or miss pages.

### Proposed Solution

Amend `Rapid7ApiClient` to follow the provider’s Log Search polling and pagination model:

1. Submit initial query request with `from`, `to`, and `query` parameters.
2. Poll the `Self` continuation link until the query completes.
3. Follow the `Next` link to fetch subsequent pages, polling to completion as needed.
4. Handle HTTP 429 rate limiting using `X-RateLimit-Reset`.
5. Emit structured logs for all operationally important events (query start, polls, pages, rate limiting, completion/failure).

### Business Justification

Aligning with the provider’s documented behavior improves ingestion reliability and reduces operational risk from rate limiting and partial data retrieval.

---

## Affected Components

**Modules/Files**:
- `src/log_ingestion/api_client.py` (primary behavior change)
- `src/log_ingestion/config.py` (add provider-specific settings required for Log Search)
- `tests/test_api_client.py` (new tests for polling/pagination/rate-limit reset)
- `docs/requirements/rtm.md` (add/update atomic requirements and traceability)
- `docs/requirements/slos.md` (optional: add SLI/SLOs for logsearch latency/error rate)

---

## Approval Status

**Approval Token Received**: _PENDING_  
Accepted tokens: "Approved to Proceed", "ATP", "Go Ahead", "Implement"

---

## Change History

| Date | Status | Notes |
|------|--------|-------|
| 2026-02-10 | DRAFT | CR created |

---

**End of Change Request CR-2026-02-10-002**
