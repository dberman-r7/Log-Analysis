# CR-2026-02-11-002: Align Log Search query workflow with Rapid7 Self/Next polling spec and epoch-millis timestamps

## Title

Align Log Search query workflow with Rapid7 Self/Next polling spec and epoch-millis timestamps

## Requestor

User

## Date

2026-02-11

## Category

BUG

## Priority

P1-HIGH

## Description

The log ingestion utility currently submits Log Search queries using ISO8601 strings for `from`/`to`, which leads to 404 responses in the target Rapid7 environment. Rapid7’s reference flow indicates the query endpoint expects **epoch milliseconds**, and results must be retrieved by:

- submitting `GET /query/logs/{logKey}` with `from`, `to`, and `query`
- polling until completion using `links[rel=Self]`
- retrieving additional pages using `links[rel=Next]`
- handling rate limiting via HTTP 429, sleeping until reset and retrying

This change will:

1) Convert CLI-provided ISO8601 timestamps to epoch-millis at the service boundary.
2) Tighten the API client query implementation to match the Rapid7 polling/pagination spec.
3) Add/adjust tests to lock the behavior.

## Business Justification

- Fixes a blocking functional defect (pipeline fails with 404) and makes the query flow compatible with Rapid7’s documented behavior.
- Improves reliability by making the polling and pagination behavior deterministic and well-tested.
- Reduces operator confusion by logging both ISO8601 and epoch-millis and failing loudly with actionable guidance.

## Affected Components

- `src/log_ingestion/service.py` (time conversion boundary)
- `src/log_ingestion/api_client.py` (query/poll/paginate + 429 handling)
- `tests/test_service.py` (new unit test for millis conversion)
- `tests/test_api_client.py` (query/poll/next + 429 tests)
- `docs/requirements/rtm.md` (REQ entries for epoch-millis conversion behavior)
- `docs/requirements/slos.md` (optional: clarify latency SLI/SLO measurement around polling)
